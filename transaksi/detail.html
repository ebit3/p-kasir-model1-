<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Detail Transaksi</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
        <style>
            /* Styling umum untuk layar */
            .receipt {
                max-width: 400px;
                margin: 0 auto;
                border: 1px solid #ddd;
                padding: 20px;
                border-radius: 10px;
                background-color: #fff;
            }

            /* Styling khusus untuk cetak */
            @media print {
                body {
                    background-color: white;
                }

                .receipt {
                    width: 100%;
                    max-width: none;
                    border: none;
                    padding: 0;
                    margin: 0;
                }

                .receipt-header h2 {
                    font-size: 20px;
                }

                .receipt-header p {
                    font-size: 12px;
                    color: #333;
                }

                .receipt-items li {
                    margin-bottom: 10px;
                }

                .receipt-total {
                    font-size: 14px;
                }

                .text-end {
                    text-align: end;
                }

                /* Sembunyikan tombol saat mencetak */
                #printButton {
                    display: none;
                }

                /* Pengaturan margin dan padding khusus cetak */
                @page {
                    size: auto;
                    margin: 10mm;
                }
            }

            /* Media query untuk perangkat mobile */
            @media (max-width: 600px) {
                .receipt {
                    padding: 10px;
                    font-size: 12px;
                }

                .receipt-header h2 {
                    font-size: 18px;
                }

                .receipt-header p {
                    font-size: 10px;
                }

                .receipt-items li {
                    margin-bottom: 5px;
                }

                .receipt-total {
                    font-size: 14px;
                }
            }
        </style>

    </head>

    <body>
        <div class="container mt-5">
            <div class="receipt">

                <div class="receipt-details" id="transactionDetail">
                    <!-- Transaction details will be populated here -->
                </div>

                <div class="text-end">
                    <button id="printButton" class="btn btn-primary">Print</button>
                </div>
            </div>
        </div>

        <script type="module">
            import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
            import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

            const firebaseConfig = {
                apiKey: "AIzaSyAPRiQzK5Pozzr79bdbnKJ4IRePqsh1F_Q",
                authDomain: "curdprojek.firebaseapp.com",
                databaseURL: "https://curdprojek-default-rtdb.asia-southeast1.firebasedatabase.app",
                projectId: "curdprojek",
                storageBucket: "curdprojek.appspot.com",
                messagingSenderId: "652515266449",
                appId: "1:652515266449:web:9ff63cf0548e94340cd430",
                measurementId: "G-B9DJ4L79G2"
            };

            const app = initializeApp(firebaseConfig);
            const database = getDatabase(app);

            const transactionId = new URLSearchParams(window.location.search).get('id');
            const transactionDetail = document.getElementById('transactionDetail');

            function loadTransactionDetail(id) {
                const transactionRef = ref(database, `transactions/${id}`);
                get(transactionRef).then((snapshot) => {
                    if (snapshot.exists()) {
                        const transaction = snapshot.val();

                        transactionDetail.innerHTML = `                    
                        <p><strong>Muji Perkasa</strong></p>
                        <p class="text-center">Jl. Merdeka No.123, Jakarta</p>
                        <p class="text-center">Telp: 012-3456789</p>
                        <hr>
                        <p><strong>Kode Transaksi:</strong> ${transaction.transactionCode}</p>
                        <p><strong>Tanggal:</strong> ${new Date(transaction.date).toLocaleString()}</p>
                        <hr>
                        ================================                        
                        <div class="receipt-items">
                            <h5>Daftar Produk:</h5>
                            <ul>
                                ${transaction.items.map(item => `
                                    <li>
                                        ${item.name} <span>${item.quantity} x Rp ${item.price.toLocaleString()} = Rp ${item.subtotal.toLocaleString()}</span>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                        <hr>
                        ================================
                        <p><strong>Total Pembayaran:</strong> Rp ${transaction.totalPayment.toLocaleString()}</p>
                        <p><strong>Uang Diterima:</strong> Rp ${transaction.cashReceived.toLocaleString()}</p>
                        <p><strong>Kembalian:</strong> Rp ${transaction.change.toLocaleString()}</p>
                        <hr>
                        <p class="text-center">Terima kasih telah berbelanja!</p>
                        <br>
                    `;
                    } else {
                        transactionDetail.innerHTML = '<p>Transaksi tidak ditemukan.</p>';
                    }
                }).catch((error) => {
                    console.error('Error loading transaction details:', error);
                    transactionDetail.innerHTML = '<p>Terjadi kesalahan saat memuat detail transaksi.</p>';
                });
            }

            loadTransactionDetail(transactionId);

            document.getElementById('printButton').addEventListener('click', async function () {
                try {
                    const device = await navigator.bluetooth.requestDevice({
                        filters: [{ services: ['000018f0-0000-1000-8000-00805f9b34fb'] }]  // Ganti dengan UUID yang benar
                    });

                    const server = await device.gatt.connect();
                    const service = await server.getPrimaryService('000018f0-0000-1000-8000-00805f9b34fb');  // Ganti dengan UUID yang benar
                    const characteristic = await service.getCharacteristic('00002af1-0000-1000-8000-00805f9b34fb');  // Ganti dengan UUID karakteristik yang benar

                    const printData = new TextEncoder().encode(transactionDetail.innerText);
                    await characteristic.writeValue(printData);

                    alert('Data telah berhasil dicetak melalui Bluetooth!');

                } catch (error) {
                    console.error('Error connecting to printer:', error);
                    alert('Gagal menghubungkan ke printer. Silakan coba lagi.');
                }
            });
        </script>

    </body>

</html>